<!DOCTYPE html>
<html>
<head>
    <title>â˜­ USSR Economy Simulator â˜­</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: #eee;
            padding: 20px;
        }
        .section {
            border: 1px solid #555;
            padding: 10px;
            margin-bottom: 10px;
        }
        button, select {
            margin: 4px;
            padding: 8px 12px;
            background-color: #333;
            color: #eee;
            border: 1px solid #777;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover, select:hover {
            background-color: #555;
        }
        .met {
            color: lightgreen;
            font-weight: bold;
        }
        .not-met {
            color: red;
        }
        #warning {
            color: orange;
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        #policyEffects {
            margin-top: 10px;
            font-style: italic;
            color: #ccc;
        }
        .save-load-buttons button {
            background-color: #007bff;
            border-color: #007bff;
        }
        .save-load-buttons button:hover {
            background-color: #0056b3;
        }
        .reset-button button {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .reset-button button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <h1>â˜­ USSR Economy Simulator â˜­</h1>

    <div class="section save-load-buttons">
        <h2>Game Management</h2>
        <button onclick="saveGame(true)">Save Game</button>
        <button onclick="loadGame()">Load Game</button>
        <div class="reset-button" style="margin-top: 10px;">
            <button onclick="resetGame()">Reset Game</button>
        </div>
        <p id="gameMessage" style="color: yellow;"></p>
    </div>

    <div class="section">
        <h2>Choose Policy</h2>
        <select id="policySelect" onchange="selectPolicy()">
            <option value="none">-- Select Policy --</option>
            <option value="marxism">Marxism</option>
            <option value="stalinism">Stalinism</option>
            <option value="maoism">Maoism</option>
            <option value="anarcho">Anarcho-Communism</option>
            <option value="leninism">Leninism</option>
            <option value="trotskyism">Trotskyism</option>
            <option value="kronstadtism">Kronstadtism</option>
        </select>
        <p>Current Policy: <strong id="currentPolicy">None</strong></p>
        <p id="policyEffects"></p>
    </div>

    <div class="section">
        <h2>Stats</h2>
        <p>Manpower: <span id="manpower">0</span></p>
        <p>Workers: <span id="workers">0</span></p>
        <p>Population: <span id="population">0</span></p>
    </div>

    <div class="section">
        <h2>Hire Workers</h2>
        <button onclick="hireWorker()">Hire Worker (Cost: <span id="workerCost">10</span> manpower)</button>
    </div>

    <div class="section">
        <h2>Assign Workers</h2>
        <p>Unassigned Workers: <span id="unassigned">0</span></p>

        <p>Steel: <span id="steel">0</span>
            <button onclick="assignWorker('steel')">+1</button>
            <button onclick="unassignWorker('steel')">-1</button>
            (Assigned: <span id="steelWorkers">0</span>)
        </p>

        <p>Food: <span id="food">0</span>
            <button onclick="assignWorker('food')">+1</button>
            <button onclick="unassignWorker('food')">-1</button>
            (Assigned: <span id="foodWorkers">0</span>)
        </p>

        <p>Oil: <span id="oil">0</span>
            <button onclick="assignWorker('oil')">+1</button>
            <button onclick="unassignWorker('oil')">-1</button>
            (Assigned: <span id="oilWorkers">0</span>)
        </p>
    </div>

    <div class="section">
        <h2>ðŸ“‹ Daily Quota</h2>
        <p>Day: <span id="dayCount">1</span></p>
        <ul>
            <li>Steel: <span id="quotaSteel">0</span>/<span id="targetSteel">100</span></li>
            <li>Food: <span id="quotaFood">0</span>/<span id="targetFood">80</span></li>
            <li>Oil: <span id="quotaOil">0</span>/<span id="targetOil">50</span></li>
        </ul>
        <p id="quotaStatus" class="not-met">ðŸš« Quota Not Met</p>
        <p id="warning"></p>
    </div>

    <script>
        let manpower = 0;
        let workers = 0;
        let unassignedWorkers = 0;

        let steel = 0, food = 0, oil = 0;
        let steelWorkers = 0, foodWorkers = 0, oilWorkers = 0;

        let day = 1;
        let quotaSteel = 0, quotaFood = 0, quotaOil = 0;
        let baseTargetSteel = 100, baseTargetFood = 80, baseTargetOil = 50;
        let targetSteel = baseTargetSteel, targetFood = baseTargetFood, targetOil = baseTargetOil;

        let policy = "none";
        let prodMultiplier = 1;
        let workerCost = 10;
        let manpowerGain = 5; // Base manpower gain from policy
        let quotaMultiplier = 1;

        // New population variables
        let population = 500; // Starting population
        const foodConsumptionRate = 0.1; // Food consumed per person per day
        const populationGrowthRate = 0.005; // 0.5% growth if food is sufficient
        const populationDeclineRate = 0.01; // 1% decline if food is insufficient
        let populationManpowerMultiplier = 1; // Multiplier for manpower gained from population

        let gameLoopInterval; // To store the interval ID for per-second updates
        let dayLoopInterval;  // To store the interval ID for per-minute updates
        let autoSaveInterval; // To store the interval ID for auto-saving

        function display(value) {
            return (value > 0 && value < 0.01) ? "0.01" : value.toFixed(2);
        }

        let messageTimeoutId; // To manage the timeout for game messages

        function showGameMessage(message, duration = 3000) {
            const gameMessageEl = document.getElementById("gameMessage");
            gameMessageEl.innerText = message;
            // Clear any existing timeout to prevent messages from being cut short
            if (messageTimeoutId) {
                clearTimeout(messageTimeoutId);
            }
            messageTimeoutId = setTimeout(() => {
                gameMessageEl.innerText = "";
            }, duration);
        }

        function updateUI() {
            document.getElementById("manpower").innerText = display(manpower);
            document.getElementById("workers").innerText = workers;
            document.getElementById("unassigned").innerText = unassignedWorkers;
            document.getElementById("steel").innerText = display(steel);
            document.getElementById("food").innerText = display(food);
            document.getElementById("oil").innerText = display(oil);
            document.getElementById("steelWorkers").innerText = steelWorkers;
            document.getElementById("foodWorkers").innerText = foodWorkers;
            document.getElementById("oilWorkers").innerText = oilWorkers;
            document.getElementById("quotaSteel").innerText = display(quotaSteel);
            document.getElementById("quotaFood").innerText = display(quotaFood);
            document.getElementById("quotaOil").innerText = display(quotaOil);
            document.getElementById("targetSteel").innerText = targetSteel;
            document.getElementById("targetFood").innerText = targetFood;
            document.getElementById("targetOil").innerText = targetOil;
            document.getElementById("dayCount").innerText = day;
            document.getElementById("currentPolicy").innerText = policy.charAt(0).toUpperCase() + policy.slice(1);
            document.getElementById("workerCost").innerText = workerCost;
            document.getElementById("policySelect").value = policy; // Keep dropdown synced
            document.getElementById("population").innerText = Math.floor(population); // Display population as whole number

            // Show if quota met or not
            const met = quotaSteel >= targetSteel && quotaFood >= targetFood && quotaOil >= targetOil;
            const status = document.getElementById("quotaStatus");
            status.innerText = met ? "âœ… Quota Met! Glory to the Motherland!" : "ðŸš« Quota Not Met";
            status.className = met ? "met" : "not-met";
        }

        function hireWorker() {
            if (manpower >= workerCost) {
                manpower -= workerCost;
                workers++;
                unassignedWorkers++;
                updateUI();
            } else {
                showGameMessage("Not enough manpower to hire a worker!", 2000);
            }
        }

        function assignWorker(res) {
            if (unassignedWorkers <= 0) {
                showGameMessage("No unassigned workers available!", 2000);
                return;
            }
            unassignedWorkers--;
            if (res === 'steel') steelWorkers++;
            else if (res === 'food') foodWorkers++;
            else if (res === 'oil') oilWorkers++;
            updateUI();
        }

        function unassignWorker(res) {
            if (res === 'steel' && steelWorkers > 0) { steelWorkers--; unassignedWorkers++; }
            else if (res === 'food' && foodWorkers > 0) { foodWorkers--; unassignedWorkers++; }
            else if (res === 'oil' && oilWorkers > 0) { oilWorkers--; unassignedWorkers++; }
            else {
                showGameMessage("No workers assigned to " + res + " to unassign!", 2000);
                return;
            }
            updateUI();
        }

        function selectPolicy() {
            policy = document.getElementById("policySelect").value;

            // Reset modifiers
            prodMultiplier = 1;
            workerCost = 10;
            manpowerGain = 5; // Base gain from policy
            quotaMultiplier = 1;
            populationManpowerMultiplier = 1; // Default population manpower multiplier

            let effectsText = "";

            switch(policy) {
                case "marxism":
                    prodMultiplier = 1.2;
                    populationManpowerMultiplier = 1.15; // 15% more manpower from population
                    effectsText = "ðŸ“ˆ +20% output, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ +15% manpower from population";
                    break;
                case "stalinism":
                    quotaMultiplier = 1.5;
                    manpowerGain = 6;
                    populationManpowerMultiplier = 1.5; // High mobilization
                    effectsText = "ðŸ“‹ +50% quotas, ðŸ‘¨â€ðŸŒ¾ +6 base manpower/tick, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ +50% manpower from population";
                    break;
                case "maoism":
                    workerCost = 1;           // Worker cost is 1 manpower
                    manpowerGain = 2.5;       // +2.5 manpower/tick
                    prodMultiplier = 0.675;   // -32.5% production (1 - 0.325)
                    populationManpowerMultiplier = 2.0; // Extreme mass mobilization
                    effectsText = "âž– Worker cost 1 manpower, ðŸ‘¨â€ðŸŒ¾ +2.5 base manpower/tick, -32.5% output, Food production at 100%, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ +100% manpower from population";
                    break;
                case "anarcho":
                    quotaMultiplier = 0; // no quotas
                    populationManpowerMultiplier = 0.75; // Less centralized control
                    effectsText = "ðŸš« No quotas, +50% food production, -50% oil production, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ -25% manpower from population";
                    break;
                case "leninism":
                    prodMultiplier = 1.1;
                    populationManpowerMultiplier = 1.05; // Small bonus
                    effectsText = "ðŸ“ˆ +10% output, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ +5% manpower from population";
                    break;
                case "trotskyism":
                    prodMultiplier = 1.3;
                    manpowerGain = 4;
                    populationManpowerMultiplier = 1.25; // Efficient use of resources for the cause
                    effectsText = "ðŸš€ +30% output, ðŸ‘¨â€ðŸŒ¾ -1 base manpower/tick, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ +25% manpower from population";
                    break;
                case "kronstadtism":
                    manpowerGain = 8;
                    prodMultiplier = 1; // no nerf now
                    populationManpowerMultiplier = 0.9; // More voluntary, less forced
                    effectsText = "ðŸ‘¨â€ðŸŒ¾ +8 base manpower/tick, âš”ï¸ No production penalty, ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ -10% manpower from population";
                    break;
                default:
                    effectsText = "";
            }

            // Apply quotas
            targetSteel = Math.floor(baseTargetSteel * quotaMultiplier);
            targetFood = Math.floor(baseTargetFood * quotaMultiplier);
            targetOil = Math.floor(baseTargetOil * quotaMultiplier);

            document.getElementById("policyEffects").innerText = effectsText;

            updateUI();
        }

        // Added a parameter 'isManual' to differentiate between manual and auto-saves
        function saveGame(isManual = false) {
            const gameState = {
                manpower,
                workers,
                unassignedWorkers,
                steel,
                food,
                oil,
                steelWorkers,
                foodWorkers,
                oilWorkers,
                day,
                quotaSteel,
                quotaFood,
                quotaOil,
                baseTargetSteel,
                baseTargetFood,
                baseTargetOil,
                policy,
                population // Save population
            };
            localStorage.setItem('ussrEconomySave', JSON.stringify(gameState));
            if (isManual) {
                showGameMessage("Game Saved! âœ…", 2000);
            } else {
                // Auto-save message, shorter duration, only show if not currently showing another message
                const gameMessageEl = document.getElementById("gameMessage");
                if (gameMessageEl.innerText === "" || gameMessageEl.innerText === "Auto-saving...") {
                     showGameMessage("Auto-saving...", 500);
                }
            }
        }

        function loadGame() {
            const savedState = localStorage.getItem('ussrEconomySave');
            if (savedState) {
                const gameState = JSON.parse(savedState);

                manpower = gameState.manpower;
                workers = gameState.workers;
                unassignedWorkers = gameState.unassignedWorkers;
                steel = gameState.steel;
                food = gameState.food;
                oil = gameState.oil;
                steelWorkers = gameState.steelWorkers;
                foodWorkers = gameState.foodWorkers;
                oilWorkers = gameState.oilWorkers;
                day = gameState.day;
                quotaSteel = gameState.quotaSteel;
                quotaFood = gameState.quotaFood;
                quotaOil = gameState.quotaOil;
                baseTargetSteel = gameState.baseTargetSteel;
                baseTargetFood = gameState.baseTargetFood;
                baseTargetOil = gameState.baseTargetOil;
                policy = gameState.policy;
                population = gameState.population || 500; // Load population, default to 500 if not found (for old saves)


                // Reapply policy effects and update UI
                selectPolicy(); // This will recalculate multipliers like populationManpowerMultiplier
                updateUI();
                showGameMessage("Game Loaded! ðŸ“‚", 2000);
            } else {
                showGameMessage("No saved game found! Starting new game.", 2000);
                resetGame(false); // Start a new game if no save found, without prompt
            }
        }

        function resetGame(promptUser = true) {
            let confirmed = true;
            if (promptUser) {
                confirmed = confirm("Are you sure you want to reset the game? All progress will be lost.");
            }

            if (confirmed) {
                manpower = 0;
                workers = 0;
                unassignedWorkers = 0;

                steel = 0; food = 0; oil = 0;
                steelWorkers = 0; foodWorkers = 0; oilWorkers = 0;

                day = 1;
                quotaSteel = 0; quotaFood = 0; quotaOil = 0;
                baseTargetSteel = 100; baseTargetFood = 80; baseTargetOil = 50;

                policy = "none";
                population = 500; // Reset population

                localStorage.removeItem('ussrEconomySave');
                selectPolicy(); // This will reset multipliers and target quotas
                updateUI();
                if (promptUser) { // Only show message if manually reset
                    showGameMessage("Game Reset! ðŸ†•", 2000);
                }
            }
        }

                function startGameLoops() {
            // Clear existing intervals to prevent duplicates if called multiple times
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            if (dayLoopInterval) clearInterval(dayLoopInterval);
            if (autoSaveInterval) clearInterval(autoSaveInterval);

            // Game loop - every second (resource production and manpower gain)
            gameLoopInterval = setInterval(() => {
                // Calculate total manpower gain per tick
                let currentManpowerGainFromPolicy = manpowerGain; // Base from policy (e.g., 5, 6, 2.5, 4, 8)
                let manpowerFromPop = Math.floor(population / 100) * populationManpowerMultiplier;
                manpower += currentManpowerGainFromPolicy + manpowerFromPop;

                let steelGain = steelWorkers * prodMultiplier;
                let foodGain = foodWorkers * prodMultiplier;
                let oilGain = oilWorkers * prodMultiplier;

                // Maoism: food is always at 100% production (no reduction)
                if (policy === "maoism") {
                    foodGain = foodWorkers * 1; // full 100%
                }

                // Anarcho special production
                if (policy === "anarcho") {
                    foodGain *= 1.5;
                    oilGain *= 0.5;
                }

                steel += steelGain;
                food += foodGain;
                oil += oilGain;

                quotaSteel += steelGain;
                quotaFood += foodGain;
                quotaOil += oilGain;

                updateUI();
            }, 1000);

            // New day every 60s
            dayLoopInterval = setInterval(() => {
                day++;

                // Clear warning at day start
                const warningEl = document.getElementById("warning");
                warningEl.style.display = "none";
                warningEl.innerText = ""; // Clear previous warnings

                // --- Population and Food Dynamics ---
                let foodNeededForPopulation = population * foodConsumptionRate;

                // Consume food from reserves
                food -= foodNeededForPopulation;

                // Population dynamics based on food surplus/deficit
                if (food < 0) {
                    // Food deficit: population declines
                    population *= (1 - populationDeclineRate);
                    // Add warning about food shortage if it's the primary issue
                    if (!warningEl.innerText.includes("Food shortage!")) {
                        warningEl.style.display = "block";
                        warningEl.innerText = (warningEl.innerText ? warningEl.innerText + " " : "") + "âš ï¸ Food shortage! Population declining.";
                    }
                } else {
                    // Food surplus or met: population grows
                    population *= (1 + populationGrowthRate);
                }

                // Ensure population does not drop below 100 or become fractional for display
                population = Math.max(100, Math.floor(population));
                // Ensure food does not go below zero after consumption
                food = Math.max(0, food);


                // Check overproduction and apply 50% excess penalty
                const checkOverQuota = (actual, target) => {
                    // Only apply penalty if a target exists and actual is significantly over
                    if (target > 0 && actual >= target * 2.5) {
                        let excess = actual - target;
                        return Math.floor(excess * 0.5); // 50% of excess
                    }
                    return 0;
                };

                let steelPenalty = checkOverQuota(quotaSteel, targetSteel);
                let foodPenalty = checkOverQuota(quotaFood, targetFood);
                let oilPenalty = checkOverQuota(quotaOil, targetOil);

                let penaltyOccurred = steelPenalty > 0 || foodPenalty > 0 || oilPenalty > 0;

                // Remove resources and increase base quota
                steel = Math.max(0, steel - steelPenalty);
                food = Math.max(0, food - foodPenalty);
                oil = Math.max(0, oil - oilPenalty);

                baseTargetSteel += 10 + steelPenalty;
                baseTargetFood += 10 + foodPenalty;
                baseTargetOil += 5 + oilPenalty;

                // Reset daily quotas
                quotaSteel = 0;
                quotaFood = 0;
                quotaOil = 0;

                // Re-apply multiplier for policy effect
                selectPolicy();

                if (penaltyOccurred) {
                    warningEl.style.display = "block";
                    warningEl.innerText = (warningEl.innerText ? warningEl.innerText + " " : "") + "âš ï¸ Commissar demands more due to surplus! Daily quotas increased.";
                }

                updateUI();
            }, 60000);

            // AUTO-SAVE every second
            autoSaveInterval = setInterval(() => {
                saveGame(false); // Call saveGame with isManual = false for auto-save
            }, 1000);
        }

        // Initial setup on page load
        // Call loadGame first, and it will call resetGame(false) if no save is found.
        // Then, start the game loops.
        loadGame();
        startGameLoops();
    </script>
</body>
</html>
